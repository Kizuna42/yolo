# 定点カメラAI人数カウントシステム 実装計画書

## 1. プロジェクト概要

### 1.1 基本情報
- **プロジェクト名**: 定点カメラAI人数カウントシステム
- **目的**: 手動ラベリング作業のAI自動化による工数削減
- **スコープ**: 人物検出、姿勢判別、ゾーン別集計の自動化
- **期間**: [開始日] ～ [終了日]

### 1.2 成果物
- AI推論システム（YOLOv8-Poseベース）
- データ処理パイプライン
- 運用・監視ダッシュボード
- システムドキュメント一式

## 2. 実装フェーズ別詳細計画

### フェーズ1: 環境構築・技術検証（2週間）

#### 1.1 開発環境セットアップ
- [ ] **ハードウェア環境の準備**
  - [ ] GPU搭載マシンの調達・セットアップ（NVIDIA RTX 3080以上推奨）
  - [ ] ストレージ容量の確保（最低500GB SSD）
  - [ ] メモリ要件の確認（32GB以上）
  
- [ ] **ソフトウェア環境の構築**
  - [ ] Ubuntu 20.04 LTS / Windows 11のインストール
  - [ ] CUDA 11.8 + cuDNN 8.6のインストール
  - [ ] Python 3.9環境の構築（venv/conda）
  - [ ] 必要ライブラリのインストール
    - [ ] PyTorch 2.0+
    - [ ] ultralytics（YOLOv8）
    - [ ] OpenCV 4.8+
    - [ ] NumPy, Pandas, Matplotlib
    - [ ] FastAPI / Flask（API用）

#### 1.2 技術検証（PoC）
- [ ] **YOLOv8-Poseモデルの検証**
  - [ ] 事前学習済みモデルのダウンロード
  - [ ] サンプル画像での動作確認
  - [ ] 推論速度の計測（目標: 30fps以上）
  - [ ] 検出精度の初期評価
  
- [ ] **姿勢判別アルゴリズムの検証**
  - [ ] キーポイント取得の確認
  - [ ] 着席/起立判定ロジックの実装
    - [ ] 腰・膝・足首の角度計算
    - [ ] 閾値パラメータの初期設定
  - [ ] エッジケースの洗い出し

### フェーズ2: データ準備・前処理（2週間）

#### 2.1 データ収集・整理
- [ ] **カメラ映像データの準備**
  - [ ] 既存カメラシステムとの接続確認
  - [ ] 静止画抽出スクリプトの作成
  - [ ] 5分間隔での自動取得設定
  - [ ] データ保存ディレクトリ構造の設計
    ```
    /data
      /raw_images
        /2024-01-01
          /camera_01
            - 00_00_00.jpg
            - 00_05_00.jpg
      /processed
      /annotations
    ```

- [ ] **アノテーションデータの準備**
  - [ ] 既存の手動ラベリングデータの収集
  - [ ] データフォーマットの統一（COCO形式へ変換）
  - [ ] 品質チェックスクリプトの作成
  - [ ] トレーニング/検証/テストデータの分割（70:20:10）

#### 2.2 カメラキャリブレーション
- [ ] **キャリブレーション実施**
  - [ ] チェッカーボードの準備・撮影
  - [ ] 内部パラメータ（焦点距離、主点）の算出
  - [ ] 外部パラメータ（回転、並進）の算出
  - [ ] レンズ歪み係数の算出
  
- [ ] **ホモグラフィ変換の設定**
  - [ ] フロアマップの準備（CAD図面等）
  - [ ] 対応点の手動マーキング（最低4点）
  - [ ] ホモグラフィ行列の計算
  - [ ] 変換精度の検証（誤差5cm以内）

### フェーズ3: コア機能実装（3週間）

#### 3.1 推論パイプライン構築
- [ ] **人物検出モジュール**
  ```python
  class PersonDetector:
      - [ ] __init__: モデルロード
      - [ ] preprocess: 画像前処理
      - [ ] detect: 人物検出実行
      - [ ] postprocess: NMS適用、信頼度フィルタリング
  ```
  
- [ ] **姿勢推定モジュール**
  ```python
  class PoseEstimator:
      - [ ] extract_keypoints: キーポイント抽出
      - [ ] calculate_angles: 関節角度計算
      - [ ] classify_posture: 着席/起立判定
      - [ ] confidence_check: 信頼度チェック
  ```

- [ ] **座標変換モジュール**
  ```python
  class CoordinateTransformer:
      - [ ] load_homography: ホモグラフィ行列読み込み
      - [ ] transform_point: 点変換
      - [ ] inverse_transform: 逆変換
      - [ ] batch_transform: バッチ処理
  ```

#### 3.2 ゾーン判定・集計機能
- [ ] **ゾーン定義モジュール**
  ```python
  class ZoneManager:
      - [ ] load_zones: ゾーン定義ファイル読み込み
      - [ ] add_zone: ゾーン追加
      - [ ] edit_zone: ゾーン編集
      - [ ] visualize_zones: ゾーン可視化
  ```

- [ ] **人数集計モジュール**
  ```python
  class PeopleCounter:
      - [ ] assign_to_zone: ゾーン判定（cv2.pointPolygonTest）
      - [ ] count_by_zone: ゾーン別集計
      - [ ] count_by_posture: 姿勢別集計
      - [ ] generate_report: レポート生成
  ```

#### 3.3 データ入出力機能
- [ ] **入力処理**
  - [ ] カメラストリーム接続
  - [ ] 画像ファイル読み込み
  - [ ] バッチ処理対応
  - [ ] エラーハンドリング

- [ ] **出力処理**
  - [ ] JSON形式でのデータ出力
  - [ ] CSV形式でのレポート生成
  - [ ] タイムスタンプ付与
  - [ ] データベース連携（PostgreSQL/MySQL）

### フェーズ4: システム統合・最適化（2週間）

#### 4.1 モジュール統合
- [ ] **メインパイプライン実装**
  ```python
  class MainPipeline:
      - [ ] initialize: 全モジュール初期化
      - [ ] process_frame: フレーム処理
      - [ ] run: メインループ
      - [ ] cleanup: リソース解放
  ```

- [ ] **設定管理システム**
  - [ ] config.yamlの作成
  - [ ] パラメータ外部化
  - [ ] 環境別設定の分離
  - [ ] 設定値のバリデーション

#### 4.2 パフォーマンス最適化
- [ ] **推論速度の最適化**
  - [ ] バッチ処理の実装
  - [ ] モデル量子化（INT8）
  - [ ] TensorRTへの変換
  - [ ] マルチスレッド処理の実装

- [ ] **メモリ使用量の最適化**
  - [ ] メモリリークのチェック
  - [ ] 不要なデータの即座解放
  - [ ] キャッシュサイズの調整
  - [ ] ガベージコレクションの最適化

### フェーズ5: API・UI開発（2週間）

#### 5.1 REST API開発
- [ ] **APIエンドポイント設計**
  ```
  - [ ] POST /api/process/image - 画像処理
  - [ ] GET /api/zones - ゾーン情報取得
  - [ ] GET /api/counts/current - 現在の人数取得
  - [ ] GET /api/counts/history - 履歴データ取得
  - [ ] POST /api/zones - ゾーン登録
  - [ ] PUT /api/zones/{id} - ゾーン更新
  ```

- [ ] **API実装**
  - [ ] FastAPIアプリケーション作成
  - [ ] リクエストバリデーション
  - [ ] エラーハンドリング
  - [ ] レート制限の実装
  - [ ] 認証・認可（JWT）

#### 5.2 監視ダッシュボード開発
- [ ] **フロントエンド実装**
  - [ ] React/Vue.jsプロジェクト作成
  - [ ] リアルタイムデータ表示（WebSocket）
  - [ ] ゾーン別人数グラフ
  - [ ] ヒートマップ表示
  - [ ] 履歴データビューア

- [ ] **バックエンド連携**
  - [ ] WebSocket実装
  - [ ] データ更新の自動反映
  - [ ] アラート機能
  - [ ] ログ表示機能

### フェーズ6: テスト・品質保証（2週間）

#### 6.1 単体テスト
- [ ] **各モジュールのテスト**
  - [ ] PersonDetectorテスト（精度90%以上）
  - [ ] PoseEstimatorテスト（分類精度85%以上）
  - [ ] CoordinateTransformerテスト（変換誤差5cm以内）
  - [ ] ZoneManagerテスト
  - [ ] PeopleCounterテスト

- [ ] **テストカバレッジ**
  - [ ] カバレッジ80%以上の達成
  - [ ] エッジケースのテスト
  - [ ] 異常系のテスト
  - [ ] パフォーマンステスト

#### 6.2 統合テスト
- [ ] **エンドツーエンドテスト**
  - [ ] 全処理パイプラインのテスト
  - [ ] 大量データでの負荷テスト
  - [ ] 24時間連続稼働テスト
  - [ ] メモリリークテスト

- [ ] **精度検証**
  - [ ] 手動カウントとの比較（誤差5%以内）
  - [ ] 様々な照明条件でのテスト
  - [ ] 混雑時のテスト
  - [ ] オクルージョン発生時のテスト

### フェーズ7: デプロイメント・移行（1週間）

#### 7.1 本番環境準備
- [ ] **インフラ構築**
  - [ ] 本番サーバーのセットアップ
  - [ ] ネットワーク設定
  - [ ] セキュリティ設定（ファイアウォール、SSL）
  - [ ] バックアップ設定

- [ ] **デプロイメント**
  - [ ] Dockerイメージの作成
  - [ ] docker-compose.ymlの作成
  - [ ] CI/CDパイプライン構築（GitLab CI/GitHub Actions）
  - [ ] Blue-Greenデプロイメント設定

#### 7.2 データ移行・切り替え
- [ ] **並行稼働期間の設定**
  - [ ] 既存システムとの並行運用（1週間）
  - [ ] データ整合性チェック
  - [ ] 差分分析レポート作成
  - [ ] 問題発生時のロールバック手順

- [ ] **本番切り替え**
  - [ ] 切り替え作業計画書作成
  - [ ] 関係者への通知
  - [ ] 段階的切り替えの実施
  - [ ] 切り替え後の動作確認

### フェーズ8: 運用・保守体制構築（1週間）

#### 8.1 ドキュメント整備
- [ ] **技術ドキュメント**
  - [ ] システム設計書
  - [ ] API仕様書（OpenAPI）
  - [ ] データベース設計書
  - [ ] インフラ構成図

- [ ] **運用ドキュメント**
  - [ ] 運用手順書
  - [ ] トラブルシューティングガイド
  - [ ] パラメータチューニングガイド
  - [ ] バックアップ・リストア手順

#### 8.2 監視・アラート設定
- [ ] **監視項目の設定**
  - [ ] システムメトリクス（CPU、メモリ、ディスク）
  - [ ] アプリケーションメトリクス（処理時間、エラー率）
  - [ ] ビジネスメトリクス（検出人数の異常値）
  - [ ] ログ監視（エラーログ、警告ログ）

- [ ] **アラート設定**
  - [ ] Slack/メール通知設定
  - [ ] エスカレーションルール
  - [ ] 対応手順書の作成
  - [ ] オンコール体制の確立

## 3. リスク管理

### 3.1 技術的リスク
| リスク項目 | 影響度 | 発生確率 | 対策 | チェック |
|-----------|--------|----------|------|----------|
| モデル精度不足 | 高 | 中 | ファインチューニング実施 | [ ] |
| 処理速度の遅延 | 高 | 低 | GPU最適化、モデル軽量化 | [ ] |
| カメラ位置変更 | 中 | 低 | 再キャリブレーション手順整備 | [ ] |
| オクルージョン | 中 | 高 | 複数カメラ統合、追跡アルゴリズム | [ ] |

### 3.2 運用リスク
| リスク項目 | 影響度 | 発生確率 | 対策 | チェック |
|-----------|--------|----------|------|----------|
| データ欠損 | 高 | 低 | 冗長化、自動リトライ | [ ] |
| システム障害 | 高 | 低 | 監視強化、自動復旧 | [ ] |
| セキュリティ侵害 | 高 | 低 | アクセス制御、暗号化 | [ ] |
| スケーラビリティ | 中 | 中 | 負荷分散、クラウド移行 | [ ] |

## 4. 成功基準

### 4.1 必須要件
- [ ] 人物検出精度: 95%以上
- [ ] 姿勢分類精度: 90%以上
- [ ] ゾーン判定精度: 98%以上
- [ ] 処理速度: リアルタイム（30fps）
- [ ] システム稼働率: 99.5%以上

### 4.2 追加目標
- [ ] 完全自動化による工数削減: 90%以上
- [ ] データ取得頻度: 5分間隔→リアルタイム
- [ ] 運用コスト削減: 50%以上
- [ ] ユーザー満足度: 4.0/5.0以上

## 5. プロジェクト体制

### 5.1 役割分担
- **プロジェクトマネージャー**: [名前]
  - [ ] 全体進捗管理
  - [ ] ステークホルダー調整
  - [ ] リスク管理

- **テクニカルリード**: [名前]
  - [ ] 技術選定
  - [ ] アーキテクチャ設計
  - [ ] コードレビュー

- **AIエンジニア**: [名前]
  - [ ] モデル実装
  - [ ] 精度改善
  - [ ] 最適化

- **バックエンドエンジニア**: [名前]
  - [ ] API開発
  - [ ] データベース設計
  - [ ] システム統合

- **フロントエンドエンジニア**: [名前]
  - [ ] UI/UX設計
  - [ ] ダッシュボード開発
  - [ ] ユーザビリティテスト

## 7. 完了基準チェックリスト

### 最終確認項目
- [ ] 全機能の実装完了
- [ ] テストカバレッジ80%以上達成
- [ ] 性能要件の達成確認
- [ ] セキュリティ監査完了
- [ ] ドキュメント一式の完成
- [ ] 運用手順書の承認
- [ ] 本番環境へのデプロイ完了
- [ ] 並行稼働期間の完了
- [ ] ユーザー教育の実施
- [ ] プロジェクトクロージング

---

**改訂履歴**
| 版数 | 日付 | 改訂内容 | 作成者 |
|------|------|----------|--------|
| 1.0 | 2024-XX-XX | 初版作成 | [名前] |
| | | | |